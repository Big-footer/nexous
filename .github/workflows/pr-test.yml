name: PR Test & Trace Diff

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'nexous/**'
      - 'projects/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'pyproject.toml'

env:
  BASELINE_RUN_ID: baseline_002_docker
  PROJECT_PATH: projects/flood_analysis_ulsan/project.yaml

jobs:
  test-and-diff:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ (baseline trace Ï†ëÍ∑º)
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      
      - name: Check baseline trace exists
        id: check-baseline
        run: |
          if [ -f "traces/flood_analysis_ulsan/${{ env.BASELINE_RUN_ID }}/trace.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Baseline trace found: ${{ env.BASELINE_RUN_ID }}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Baseline trace not found: ${{ env.BASELINE_RUN_ID }}"
          fi
      
      - name: Run DRY replay on baseline
        if: steps.check-baseline.outputs.exists == 'true'
        run: |
          echo "üé≠ DRY Replay Baseline"
          python -m nexous.cli.main replay \
            traces/flood_analysis_ulsan/${{ env.BASELINE_RUN_ID }}/trace.json \
            --mode dry
      
      - name: Run PR test (Mock)
        run: |
          echo "üöÄ Running PR test (Mock mode)"
          PR_RUN_ID="pr_${{ github.event.pull_request.number }}_${{ github.sha }}"
          
          python -m nexous.cli.main run \
            ${{ env.PROJECT_PATH }} \
            --trace-dir traces \
            --run-id "$PR_RUN_ID"
          
          echo "PR_RUN_ID=$PR_RUN_ID" >> $GITHUB_ENV
      
      - name: Compare with baseline
        if: steps.check-baseline.outputs.exists == 'true'
        id: diff
        run: |
          echo "üìä Comparing traces"
          
          python -m nexous.cli.main diff \
            traces/flood_analysis_ulsan/${{ env.BASELINE_RUN_ID }}/trace.json \
            traces/flood_analysis_ulsan/${{ env.PR_RUN_ID }}/trace.json \
            > diff_report.txt
          
          cat diff_report.txt
          
          echo "DIFF_REPORT<<EOF" >> $GITHUB_ENV
          cat diff_report.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Check performance regression
        if: steps.check-baseline.outputs.exists == 'true'
        id: perf-check
        run: |
          # TraceÏóêÏÑú duration Ï∂îÏ∂ú
          BASELINE_MS=$(jq '.duration_ms' traces/flood_analysis_ulsan/${{ env.BASELINE_RUN_ID }}/trace.json)
          PR_MS=$(jq '.duration_ms' traces/flood_analysis_ulsan/${{ env.PR_RUN_ID }}/trace.json)
          
          echo "Baseline: ${BASELINE_MS}ms"
          echo "PR: ${PR_MS}ms"
          
          # 50% Ïù¥ÏÉÅ ÎäêÎ†§ÏßÄÎ©¥ Í≤ΩÍ≥†
          THRESHOLD=$(echo "$BASELINE_MS * 1.5" | bc)
          
          if (( $(echo "$PR_MS > $THRESHOLD" | bc -l) )); then
            echo "‚ö†Ô∏è  Performance regression detected!"
            echo "regression=true" >> $GITHUB_OUTPUT
            echo "baseline_ms=$BASELINE_MS" >> $GITHUB_OUTPUT
            echo "pr_ms=$PR_MS" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Performance OK"
            echo "regression=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload trace artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-traces
          path: |
            traces/flood_analysis_ulsan/${{ env.PR_RUN_ID }}/
            diff_report.txt
          retention-days: 30
      
      - name: Comment PR with results
        if: steps.check-baseline.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const diffReport = fs.readFileSync('diff_report.txt', 'utf8');
            const regression = '${{ steps.perf-check.outputs.regression }}' === 'true';
            
            let body = '## üîç NEXOUS Trace Diff Report\n\n';
            body += '### Comparison\n';
            body += `- **Baseline**: \`${{ env.BASELINE_RUN_ID }}\`\n`;
            body += `- **PR Run**: \`${{ env.PR_RUN_ID }}\`\n\n`;
            
            if (regression) {
              body += '### ‚ö†Ô∏è  Performance Regression Detected\n';
              body += `- Baseline: ${{ steps.perf-check.outputs.baseline_ms }}ms\n`;
              body += `- PR: ${{ steps.perf-check.outputs.pr_ms }}ms\n`;
              body += `- Increase: ${((${{ steps.perf-check.outputs.pr_ms }} / ${{ steps.perf-check.outputs.baseline_ms }} - 1) * 100).toFixed(1)}%\n\n`;
            } else {
              body += '### ‚úÖ Performance OK\n\n';
            }
            
            body += '### Diff Output\n';
            body += '```\n' + diffReport + '\n```\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
